<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NFT Raffle</title>
    <link rel="stylesheet" href="main.css">
</head>
<body>
    <div class="container">
        <h1>NFT Raffle Platform</h1>
        <button id="connectWalletButton">Connect Wallet</button>
        <p id="walletAddress">Wallet Address: Not Connected</p>

        <button id="raffleButton" style="display: none;">Create Raffle</button>
        <button id="shareButton" style="display: none;">Share Raffle Link</button>

        <div id="raffleForm">
            <h2>Create Raffle</h2>
            <div id="nftList"></div>
            <input type="number" id="ticketPrice" placeholder="Ticket Price (in SOL)" />
            <input type="datetime-local" id="raffleEndTime" placeholder="End Time" />
            <button id="createRaffleButton">Create Raffle</button>
            <div id="timer"></div>
        </div>

        <p id="raffleStatus"></p>
        <div id="activeRaffles"></div>
        <div id="pastRaffles"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        let walletAddress = '';
        let nfts = [];
        let selectedNft = null;
        let countdownInterval;

        async function connectWallet() {
            if (window.solana && window.solana.isPhantom) {
                try {
                    const resp = await window.solana.connect();
                    walletAddress = resp.publicKey.toString();
                    document.getElementById('walletAddress').innerText = `Wallet Address: ${walletAddress}`;
                    document.getElementById('raffleButton').style.display = 'block';
                    document.getElementById('shareButton').style.display = 'block';
                    await fetchNfts();
                    await fetchActiveRaffles();
                    await fetchPastRaffles();
                } catch (err) {
                    console.error('Connection error:', err);
                }
            } else {
                alert("Please install Phantom Wallet!");
            }
        }

        async function fetchNfts() {
            document.getElementById('raffleStatus').innerText = 'Loading NFTs...';
            try {
                const response = await axios.get(`YOUR_API_ENDPOINT?wallet=${walletAddress}`);
                
                if (response.status === 200 && Array.isArray(response.data)) {
                    nfts = response.data;

                    const nftList = document.getElementById('nftList');
                    nftList.innerHTML = '';
                    nfts.forEach((nft) => {
                        const nftItem = document.createElement('div');
                        nftItem.className = 'nftItem';
                        nftItem.innerText = nft.name; // Ensure your API provides this
                        nftItem.onclick = () => selectNft(nftItem, nft);
                        nftList.appendChild(nftItem);
                    });
                    document.getElementById('raffleForm').style.display = 'flex';
                } else {
                    throw new Error('No NFTs found or invalid response format.');
                }
            } catch (error) {
                console.error('Error fetching NFTs:', error);
                document.getElementById('raffleStatus').innerText = 'Failed to fetch NFTs. Please check your wallet and try again.';
                alert('Failed to fetch NFTs. Please check your wallet and try again.');
            } finally {
                document.getElementById('raffleStatus').innerText = '';
            }
        }

        function selectNft(nftItem, nft) {
            const nftItems = document.querySelectorAll('.nftItem');
            nftItems.forEach(item => item.classList.remove('selected'));
            nftItem.classList.add('selected');
            selectedNft = nft;
        }

        async function createRaffle() {
            const ticketPrice = parseFloat(document.getElementById('ticketPrice').value);
            const endTime = new Date(document.getElementById('raffleEndTime').value).getTime();
            const currentTime = Date.now();

            if (!selectedNft || isNaN(ticketPrice) || ticketPrice <= 0 || endTime <= currentTime) {
                alert('Please select an NFT, enter a valid ticket price, and set a future end time.');
                return;
            }

            try {
                const raffleData = {
                    walletAddress: walletAddress,
                    nftAddress: selectedNft.address,
                    ticketPrice: ticketPrice,
                    endTime: endTime
                };

                const response = await axios.post('YOUR_BACKEND_API_ENDPOINT/create-raffle', raffleData);
                
                if (response.data.success) {
                    document.getElementById('raffleStatus').innerText = `Raffle created for NFT: ${selectedNft.name} with ticket price: ${ticketPrice} SOL.`;
                    startCountdown(endTime); // Start the countdown
                    await fetchActiveRaffles();
                } else {
                    throw new Error(response.data.message);
                }
            } catch (error) {
                console.error('Error creating raffle:', error);
                alert('Failed to create raffle. Please try again.');
            }
        }

        function startCountdown(endTime) {
            clearInterval(countdownInterval);
            countdownInterval = setInterval(() => {
                const now = Date.now();
                const distance = endTime - now;

                if (distance < 0) {
                    clearInterval(countdownInterval);
                    document.getElementById('timer').innerText = 'Raffle has ended!';
                    document.getElementById('raffleStatus').innerText = `Raffle for ${selectedNft.name} has ended.`;
                    document.getElementById('createRaffleButton').disabled = true; 
                    return;
                }

                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);

                document.getElementById('timer').innerText = `Time Remaining: ${hours}h ${minutes}m ${seconds}s`;
            }, 1000);
        }

        async function fetchActiveRaffles() {
            const activeRafflesDiv = document.getElementById('activeRaffles');
            activeRafflesDiv.innerHTML = '<h3>Active Raffles</h3>';
            const response = await axios.get('YOUR_BACKEND_API_ENDPOINT/active-raffles');
            response.data.forEach(raffle => {
                const raffleItem = document.createElement('div');
                raffleItem.className = 'raffleItem';
                raffleItem.innerText = `NFT: ${raffle.nftName}, Ends: ${new Date(raffle.endTime).toLocaleString()}`;
                activeRafflesDiv.appendChild(raffleItem);
            });
        }

        async function fetchPastRaffles() {
            const pastRafflesDiv = document.getElementById('pastRaffles');
            pastRafflesDiv.innerHTML = '<h3>Past Raffles</h3>';
            const response = await axios.get('YOUR_BACKEND_API_ENDPOINT/past-raffles');
            response.data.forEach(raffle => {
                const raffleItem = document.createElement('div');
                raffleItem.className = 'raffleItem';
                raffleItem.innerText = `NFT: ${raffle.nftName}, Ended: ${new Date(raffle.endTime).toLocaleString()}`;
                pastRafflesDiv.appendChild(raffleItem);
            });
        }

        document.getElementById('connectWalletButton').onclick = connectWallet;
        document.getElementById('createRaffleButton').onclick = createRaffle;

        window.onload = () => {
            if (window.solana && window.solana.isPhantom) {
                window.solana.connect({ onlyIfTrusted: true })
                .then(({ publicKey }) => {
                    walletAddress = publicKey.toString();
                    document.getElementById('walletAddress').innerText = `Wallet Address: ${walletAddress}`;
                    document.getElementById('raffleButton').style.display = 'block';
                    document.getElementById('shareButton').style.display = 'block';
                    fetchNfts();
                    fetchActiveRaffles();
                    fetchPastRaffles();
                })
                .catch((err) => console.error('Connection error:', err));
            } else {
                alert("Please install Phantom Wallet!");
            }
        }
    </script>
</body>
</html>
