<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NFT Raffle Platform</title>
    <link rel="stylesheet" href="main.css">
</head>
<body>
    <div class="container">
        <h1>NFT Raffle Platform</h1>
        <button id="connectWalletButton">Connect Wallet</button>
        <p id="walletAddress">Wallet Address: Not Connected</p>

        <button id="raffleButton" style="display: none;">Create Raffle</button>
        <button id="shareButton" style="display: none;">Share Raffle Link</button>

        <div id="raffleForm" style="display: none;">
            <h2>Create Raffle</h2>
            <div id="nftList"></div>
            <input type="number" id="ticketPrice" placeholder="Ticket Price (in SOL)" />
            <input type="datetime-local" id="raffleEndTime" placeholder="End Time" />
            <button id="createRaffleButton">Create Raffle</button>
            <div id="timer"></div>
        </div>

        <p id="raffleStatus"></p>
        <div id="activeRaffles"></div>
        <div id="pastRaffles"></div>

        <div id="instructions">
            <h2>How to Use the Platform</h2>
            <p>1. Click on "Connect Wallet" to connect your Phantom wallet.</p>
            <p>2. Select an NFT from your wallet to create a raffle.</p>
            <p>3. Enter the ticket price and set the raffle end time.</p>
            <p>4. Click "Create Raffle" to start the raffle.</p>
            <p>5. Share the raffle link using the "Share Raffle Link" button.</p>
            <p>All transaction fees of 0.005 SOL will be stored in our wallet: <strong>78UVfn2ptcByR1jRr7XG9rJD4wVcWuLbZ1SegQy4KAac</strong></p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        let walletAddress = '';
        let nfts = [];
        let selectedNft = null;
        let countdownInterval;

        async function connectWallet() {
            if (window.solana && window.solana.isPhantom) {
                try {
                    const resp = await window.solana.connect();
                    walletAddress = resp.publicKey.toString();
                    document.getElementById('walletAddress').innerText = `Wallet Address: ${walletAddress}`;
                    document.getElementById('raffleButton').style.display = 'block';
                    document.getElementById('shareButton').style.display = 'block';
                    await fetchNfts();
                    await fetchActiveRaffles();
                    await fetchPastRaffles();
                } catch (err) {
                    console.error('Connection error:', err);
                }
            } else {
                alert("Please install Phantom Wallet!");
            }
        }

        async function fetchNfts() {
            document.getElementById('raffleStatus').innerText = 'Loading NFTs...';
            try {
                // Replace with your method to fetch NFTs
                const response = await axios.get(`YOUR_API_ENDPOINT?wallet=${walletAddress}`);
                nfts = response.data;

                const nftList = document.getElementById('nftList');
                nftList.innerHTML = '';
                nfts.forEach((nft) => {
                    const nftItem = document.createElement('div');
                    nftItem.className = 'nftItem';
                    nftItem.innerText = nft.name; // Ensure your API provides this
                    nftItem.onclick = () => selectNft(nftItem, nft);
                    nftList.appendChild(nftItem);
                });
                document.getElementById('raffleForm').style.display = 'flex';
            } catch (error) {
                console.error('Error fetching NFTs:', error);
                alert('Failed to fetch NFTs. Please try again.');
            } finally {
                document.getElementById('raffleStatus').innerText = '';
            }
        }

        function selectNft(nftItem, nft) {
            const nftItems = document.querySelectorAll('.nftItem');
            nftItems.forEach(item => item.classList.remove('selected'));
            nftItem.classList.add('selected');
            selectedNft = nft;
        }

        async function createRaffle() {
            const ticketPrice = parseFloat(document.getElementById('ticketPrice').value);
            const endTime = new Date(document.getElementById('raffleEndTime').value).getTime();
            const currentTime = Date.now();

            if (!selectedNft || isNaN(ticketPrice) || ticketPrice <= 0 || endTime <= currentTime) {
                alert('Please select an NFT, enter a valid ticket price, and set a future end time.');
                return;
            }

            try {
                // Simulate raffle creation without API
                console.log('Creating raffle for:', {
                    walletAddress,
                    nftAddress: selectedNft.address,
                    ticketPrice,
                    endTime
                });

                document.getElementById('raffleStatus').innerText = `Raffle created for NFT: ${selectedNft.name} with ticket price: ${ticketPrice} SOL.`;
                startCountdown(endTime);
                await fetchActiveRaffles(); // Update active raffles display
            } catch (error) {
                console.error('Error creating raffle:', error);
                alert('Failed to create raffle. Please try again.');
            }
        }

        function startCountdown(endTime) {
            clearInterval(countdownInterval);
            countdownInterval = setInterval(() => {
                const now = Date.now();
                const distance = endTime - now;

                if (distance < 0) {
                    clearInterval(countdownInterval);
                    document.getElementById('timer').innerText = 'Raffle has ended!';
                    document.getElementById('raffleStatus').innerText = `Raffle for ${selectedNft.name} has ended.`;
                    return;
                }

                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);

                document.getElementById('timer').innerText = `Time Remaining: ${hours}h ${minutes}m ${seconds}s`;
            }, 1000);
        }

        async function fetchActiveRaffles() {
            // Fetch active raffles logic here
        }

        async function fetchPastRaffles() {
            // Fetch past raffles logic here
        }

        document.getElementById('connectWalletButton').onclick = connectWallet;
        document.getElementById('createRaffleButton').onclick = createRaffle;
        document.getElementById('raffleButton').onclick = () => {
            document.getElementById('raffleForm').style.display = 'flex';
        };
    </script>
</body>
</html>
